//Return Geometry Object
//
//Sample Inputs:
// var line = "LINESTRING(-13168634.8981 4026429.6236,-13168632.6717 4026903.5277,-13168633.785 4027126.3901,-13168632.6717 4027342.5441,-13168633.785 4027527.8222,-13168633.785 4027768.1511,-13168633.785 4028013.8557,-13168637.1245 4028503.9382,-13168637.1245 4028748.316,-13168637.1245 4028759.0581,-13168629.3322 4028759.0581,-13168593.7099 4028806.0544,-13168593.7099 4028818.1392,-13168629.3322 4028874.5352,-13168629.3322 4028886.62,-13168638.2378 4028886.62,-13168638.2378 4029159.2047,-13168637.1245 4029540.5656,-13168640.4642 4029901.796,-13168640.4642 4030424.1904,-13168639.3509 4030872.7434,-13168639.3509 4030876.7723,-13168634.8981 4030883.4874,-13168633.785 4030947.9516,-13168633.785 4031067.4799,-13168631.5586 4031239.3882)";
// var polygon = "POLYGON((-118.254840771884 34.1287314870685,-118.254983539259 34.1248053761672,-118.255112029896 34.1239202157454,-118.255397566445 34.1233348686093,-118.255697377932 34.1228780121106,-118.25783889305 34.120822158316,-118.258110151063 34.1206365598295,-118.261093994592 34.1178240371497,-118.264349097933 34.1149829609949,-118.265020106393 34.114411889697,-118.26593381939 34.1133268558498,-118.266033755653 34.1130698736758,-118.265733944166 34.1124559730648,-118.265077213343 34.111185340731,-118.263421108198 34.1071878470416,-118.262707270424 34.1068166509677,-118.260922673742 34.1060457053451,-118.25908097101 34.1044895382616,-118.259192806203 34.1043765132655,-118.259198754319 34.1008430139939,-118.259240394728 34.0978210976656,-118.259258240875 34.0941686261812,-118.258451366437 34.0913749011308,-118.258549519345 34.0910120327791,-118.258921308971 34.0903576806625,-118.259284177323 34.0894624091629,-118.259801947602 34.086912458843,-118.260099380382 34.0829566046637,-118.26042655644 34.078108453942,-118.264798815613 34.0773648719913,-118.265661370676 34.0775433316595,-118.266256236236 34.0781679395988,-118.269825426902 34.0800120219373,-118.27107464368 34.0813207261706,-118.272770009628 34.0825104563925,-118.273721795424 34.0832540383432,-118.27455460631 34.0848006879015,-118.277261242812 34.0903626781951,-118.278926866382 34.0909575428564,-118.280414029384 34.0925636789706,-118.281098123879 34.0925041933139,-118.281603758706 34.0923554760245,-118.283447841944 34.0911657458026,-118.284537456938 34.0909144572365,-118.309146019773 34.0907493399101,-118.309151968788 34.0940508419728,-118.309151968788 34.1077922301274,-118.296302879874 34.1102311771272,-118.280182031276 34.1132649896876,-118.277683596821 34.1135029359118,-118.272091864148 34.1161203425798,-118.2716159717 34.116953155264,-118.271675458256 34.1195110753759,-118.270902133027 34.1208197787099,-118.269058050688 34.1231992400529,-118.262276586895 34.1266494576064,-118.258469450005 34.1287314870685,-118.254840771884 34.1287314870685))"
// var multiline = "MULTILINESTRING((-13185656.5716 4049076.7994,-13185656.5716 4058618.984,-13185656.5716 4059099.5075,-13185815.5 4059395.8404,-13185822.1219 4061734.7399,-13185801.98 4061820.6889,-13185755.6259 4061884.7757,-13184537.1761 4062954.2762,-13182688.9722 4064589.5629),(-13187598.7453 4049480.9521,-13187602.2771 4057916.8155,-13187612.8723 4058096.1975,-13187644.6579 4058224.3292,-13187708.2292 4058314.0222,-13187750.61 4058429.3429,-13187771.8005 4058570.292,-13187729.4196 4064504.557),(-13195375.8807 4051484.2597,-13195366.345 4051532.2808,-13195375.5628 4055849.6434,-13195390.9259 4065748.8397),(-13178832.8767 4060177.0868,-13180760.9245 4062383.1101,-13182688.9722 4064589.5629),(-13182688.9722 4064589.5629,-13183430.5967 4065438.3906),(-13182688.9722 4064589.5629,-13181530.7838 4065614.4458))"
// var point = "POINT(-118.496712171729 34.319990978401)"

//Sample Output
// {
// 	type: "LINESTRING",
// 	coordinates: [
// 		[x1, y1],
// 		[x2, x2],
// 		[xN, yN]
// 	]
// }

var proj4 = require('proj4'); //Library to convert between coordinates systems

function parseMultiLine (strML) {
	var finalArray = [];
	var tempArr = [];
	var beginPos = strML.indexOf('(');

	while (strML.charAt(beginPos) === "(") {
		beginPos++;
	}

	var endPos = strML.length -1;

	while (strML.charAt(endPos) === ")") {
		endPos--;
	}

	var tempStr = strML.substring(beginPos -1, endPos +2);

	while (tempStr.length > 0) {
		var begin = tempStr.indexOf('(');
		var end = tempStr.indexOf(')');
		var newEntry = tempStr.substring(begin, end+1);
		if (newEntry.length > 0) {tempArr.push(newEntry)} else {break}
		tempStr = tempStr.substring(end+2, tempStr.length-1);
	}

	tempArr.forEach(function(el) {
		finalArray.push(createCoordArray(el));
	});

	return finalArray;

}

function createCoordArray(parseDb) {
	var beginPos = parseDb.indexOf('(');

	while (parseDb.charAt(beginPos) === "(") {
		beginPos++;
	}

	var strCoordinates = parseDb
					.substring(beginPos, parseDb.indexOf(')'))
					.split(',');

	var finalArray = [];

	for (var i = 0; i < strCoordinates.length; i++) {
		var tempArr = [];
		strCoordinates[i].split(" ").forEach(function(el) {
			tempArr.push(parseFloat(el));
		});

		// finalArray.push(proj4('EPSG:3857','EPSG:4326', tempArr));
		finalArray.push(tempArr);
	}

	return finalArray;
}

function parseGeometry(dbOutput){
	var objGeometry = {};

	objGeometry.type = dbOutput.substring(0, dbOutput.indexOf('('));

	//Begin transformation of specific features
	switch(objGeometry.type){
		case("LINESTRING"):
			objGeometry.type = "LineString";
			objGeometry.coordinates = createCoordArray(dbOutput);
			break;

		case("MULTILINESTRING"):
			objGeometry.type = "LineString";
			objGeometry.coordinates = parseMultiLine(dbOutput);
			break;

		case("POLYGON"): 
			objGeometry.type = "Polygon";
			objGeometry.coordinates = [];
			objGeometry.coordinates.push(createCoordArray(dbOutput));
			break;

		case("MULTIPOLYGON"):
			objGeometry.type = "Polygon";
			objGeometry.coordinates = [];
			objGeometry.coordinates.push(createCoordArray(dbOutput));
			break;

		case("POINT"):
			objGeometry.type = "Point";
			var tempStr = dbOutput.substring(dbOutput.indexOf("(")+1, dbOutput.indexOf(")"));
			var tempArr = (tempStr).split(" ")
								   .map(function(el){
								   		return parseFloat(el)
								   	});
			// objGeometry.coordinates = proj4('EPSG:3857','EPSG:4326',tempArr);
			objGeometry.coordinates = tempArr;
			break;
	}

	return objGeometry;
}

module.exports = parseGeometry;
// console.log(JSON.stringify(parseGeometry(multiline)));